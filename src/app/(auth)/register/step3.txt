// src/app/(auth)/register/step3.tsx
import useAuthStore from '@/src/lib/stores/useAuthStore';
import { UserPreferences } from '@/src/types/User';
import { router } from 'expo-router';
import React, { useState } from 'react';
import { Alert, StyleSheet, Switch, Text, TouchableOpacity, View } from 'react-native';
import RNPickerSelect from 'react-native-picker-select';

export default function RegisterStep3() {
  const [learningMode, setLearningMode] = useState('2'); // 使用字符串状态
  const [enableSpelling, setEnableSpelling] = useState(false);
  const [pronunce, setPronunce] = useState('1'); // 使用字符串状态
  const [isLoading, setIsLoading] = useState(false);
  
  const { user, updatePreferences } = useAuthStore();

  const handleFinish = async () => {
    setIsLoading(true);
    
    try {
      // 准备用户偏好数据，将字符串转换为数字
      const updates: Partial<UserPreferences> = {
        learningMode: learningMode,
        pronunce: parseInt(pronunce, 10), // 转换为数字
        enableSpelling,
      };

      // 保存到状态管理
      await updatePreferences(updates);
      
      // 导航到主应用
      router.replace('/(tabs)/today');
    } catch (error: any) {
      Alert.alert('保存失败', error.message || '请稍后重试');
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <View style={styles.container}>
      <Text style={styles.title}>定制你的学习计划</Text>
      <Text style={styles.subtitle}>步骤 3/3</Text>

      <Text style={styles.label}>选择学习模式</Text>
      <View style={styles.modeCardContainer}>
        {[
          { id: '1', name: '轻松模式', desc: '10-15分钟 | 5词+1组+1句' },
          { id: '2', name: '正常模式', desc: '15-20分钟 | 7词+1组+1句' },
          { id: '3', name: '努力模式', desc: '20-25分钟 | 10词+2组+1-2句' },
        ].map((mode) => (
          <TouchableOpacity
            key={mode.id}
            style={[styles.modeCard, learningMode === mode.id && styles.selectedModeCard]}
            onPress={() => setLearningMode(mode.id)}
          >
            <Text style={[styles.modeName, learningMode === mode.id && styles.selectedModeName]}>{mode.name}</Text>
            <Text style={styles.modeDesc}>{mode.desc}</Text>
          </TouchableOpacity>
        ))}
      </View>

      <View style={styles.switchContainer}>
        <Text style={styles.label}>启用拼写测试</Text>
        <Switch
          trackColor={{ false: "#767577", true: "#81b0ff" }}
          thumbColor={enableSpelling ? "#4A90E2" : "#f4f3f4"}
          onValueChange={setEnableSpelling}
          value={enableSpelling}
        />
      </View>

      <Text style={styles.label}>发音偏好</Text>
      <View style={styles.pickerContainer}>
        <RNPickerSelect
          onValueChange={(value) => setPronunce(value)}
          items={[
            { label: '英式发音', value: '1' },
            { label: '美式发音', value: '2' },
          ]}
          value={pronunce}
          style={pickerSelectStyles}
          useNativeAndroidPickerStyle={false}
        />
      </View>

      <TouchableOpacity 
        style={[styles.button, isLoading && styles.buttonDisabled]} 
        onPress={handleFinish}
        disabled={isLoading}
      >
        <Text style={styles.buttonText}>
          {isLoading ? '保存中...' : '完成，开始学习！'}
        </Text>
      </TouchableOpacity>
    </View>
  );
}

const styles = StyleSheet.create({
  container: { flex: 1, justifyContent: 'center', padding: 20 },
  title: { fontSize: 20, fontWeight: 'bold', marginBottom: 10, textAlign: 'center' },
  subtitle: { fontSize: 16, color: 'gray', marginBottom: 20, textAlign: 'center' },
  label: { fontSize: 16, marginBottom: 10, marginTop: 15 },
  modeCardContainer: { marginBottom: 15 },
  modeCard: {
    borderWidth: 1,
    borderColor: '#ccc',
    borderRadius: 8,
    padding: 15,
    marginBottom: 10,
    backgroundColor: '#fff',
  },
  selectedModeCard: {
    borderColor: '#4A90E2',
    backgroundColor: '#e3f2fd', // Light blue background for selected
  },
  modeName: {
    fontSize: 18,
    fontWeight: 'bold',
    marginBottom: 5,
  },
  selectedModeName: {
    color: '#4A90E2',
  },
  modeDesc: {
    fontSize: 14,
    color: 'gray',
  },
  switchContainer: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 15,
  },
  pickerContainer: {
    borderWidth: 1,
    borderColor: '#ccc',
    borderRadius: 5,
    marginBottom: 20,
    justifyContent: 'center',
  },
  button: { backgroundColor: '#4A90E2', padding: 15, borderRadius: 5, alignItems: 'center' },
  buttonDisabled: { backgroundColor: '#A0A0A0' },
  buttonText: { color: 'white', fontWeight: 'bold' },
});

const pickerSelectStyles = StyleSheet.create({
  inputIOS: {
    fontSize: 16,
    paddingVertical: 12,
    paddingHorizontal: 10,
    borderWidth: 0,
    borderRadius: 5,
    color: 'black',
    paddingRight: 30,
  },
  inputAndroid: {
    fontSize: 16,
    paddingHorizontal: 10,
    paddingVertical: 8,
    borderWidth: 0,
    borderRadius: 5,
    color: 'black',
    paddingRight: 30,
  },
});